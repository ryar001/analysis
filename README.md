# Asset Management Analysis

This project provides a set of tools for analyzing asset management data, with a focus on trade analysis. It allows users to pull trade data from a database, perform various analyses, and generate reports and charts.

## Features

*   **Trade Analysis:** Calculates key metrics such as PnL, trade volume, weighted average prices, and position sizes.
*   **Rolling Statistics:** Computes rolling statistics over a specified time period.
*   **Data Visualization:** Generates charts to visualize net position over time.
*   **Flexible Data Filtering:** Allows filtering of trade data by symbol, date range, exchange, and strategy.
*   **Report Generation:** Saves analysis results, filtered trades, and charts to files.

## How to Use

1.  **Configuration:**
    *   Ensure you have a `db.json` file in the `common` directory with the necessary database connection details. An example `db.json` might look like this:

        ```json
        {
            "DEFAULT": {
                "Trading": {
                    "user": "your_user",
                    "password": "your_password",
                    "host": "your_host",
                    "port": "your_port",
                    "dbname": "your_db"
                }
            }
        }
        ```

2.  **Run the Analysis:**
    *   Execute the `start_analysis.py` script from the `analysis` directory:

        ```bash
        python start_analysis.py
        ```

    *   The script will prompt you to enter various parameters for the analysis, such as:
        *   Global symbol (e.g., FX-BTC/USDT)
        *   Start and end timestamps
        *   Exchange
        *   Strategy name
        *   Row limit

3.  **Output:**
    *   The analysis results will be printed to the console.
    *   The following files will be saved in the `output_files` directory:
        *   `rolling_stats/rolling_stats__{timestamp}.csv`: Rolling statistics.
        *   `filters_trades/filtered_trades__{timestamp}.csv`: The filtered trade data used in the analysis.
        *   `filters_trades/filtered_trades_analysis__{timestamp}.csv`: A summary of the trade analysis.
        *   `position_timeseries_chart/position_timeseries_chart__{timestamp}.png`: A chart showing the net position over time.

## Stats Info

This section provides a detailed breakdown of the statistics generated by the analysis script.

### Overall Results

The main analysis output provides a summary of key performance indicators for the entire filtered dataset. These metrics give a high-level overview of the trading activity's profitability and characteristics.

*   **pnl (Profit and Loss):** A simplified PnL calculated from the difference between the total value of sell trades and the total value of buy trades, adjusted by the weighted average prices. It indicates the overall profitability of the trades within the analyzed period.
*   **turnover:** A measure of PnL that only considers matched buy and sell volumes. It is calculated as `min(buy_volume, sell_volume) * (weighted_avg_sell_price - weighted_avg_buy_price)`. This is useful for understanding the profitability of round-trip trades, ignoring unrealized PnL from open positions.
*   **Execution Rate:** The percentage of initiated orders that were successfully executed (fully or partially). It measures the efficiency of order placement.
*   **Trade Counts (num_buy_trades, num_sell_trades):** The total number of buy and sell trades.
*   **Volume Analysis (total_buy_size, total_sell_size):** The total quantity of the asset bought and sold.
*   **Price Analysis (avg_weighted_buy_price, avg_weighted_sell_price):** The average price for buy and sell trades, weighted by the size of each trade. This provides a more accurate picture of the average cost basis and exit price.
*   **Position Analysis (max_long_position, max_short_position):** The largest long (positive) and short (negative) positions held during the period, indicating the maximum capital exposure.

> **Note on PnL vs. Turnover:**
> *   **PnL** provides a broader measure of profitability that includes both realized gains/losses and unrealized gains/losses from any open positions at the end of the period.
> *   **Turnover** specifically measures the profit from closed, round-trip trades where a quantity of an asset has been both bought and sold. It does not account for the change in value of any remaining open positions.

### Rolling Statistics

The `rolling_stats` output provides statistics calculated over a sliding time window (e.g., every hour), allowing for the analysis of performance trends over time.

*   **turnover:** A measure of profit and loss within the time window, calculated based on the matched volume of buys and sells. It helps to understand the profitability of round-trip trades.
*   **PnL:** The net profit or loss for the specific time window, calculated as the difference between the value of sells and buys in that period.
*   **cumPnl (Cumulative PnL):** The cumulative sum of the PnL from the start of the analysis up to the end of the current time window.
*   **Position (largest_position, smallest_position, cum_size):** The maximum, minimum, and final net position held within the window.
*   **Trade Counts (num_buy_trades, num_sell_trades):** The number of buy and sell trades within the window.
*   **Trade Sizes (lowest_size, largest_size, avg_size):** The minimum, maximum, and average size of individual trades within the window. `largest_size` and `lowest_size` refer to the largest and smallest trade quantities executed in the period, not the net position.
*   **Price (avg_weighted_buy_price, avg_weighted_sell_price):** The weighted average buy and sell prices for trades occurring only within that specific window.
*   **exec_rate:** The execution rate for orders within the window.

## Automated Reporting

This project includes scripts for automated analysis and reporting, designed to be run on a schedule (e.g., via cron). These scripts send summaries to a messaging bot (Lark) based on the configuration in `send_to_lark_settings.yaml`.

### `run_send_analysis_to_msg_bot.py`

This script automates the process of running trade analysis for specific strategies and sending a daily summary.

*   **Purpose:** To provide a daily performance overview of configured trading strategies.
*   **Functionality:**
    *   Loads account and strategy configurations from `send_to_lark_settings.yaml`.
    *   For each configured strategy, it fetches all trades from the last 24 hours.
    *   Runs the same core analysis as `trades_analysis.py` to calculate PnL, turnover, volume, etc.
    *   Optionally stores the analysis results in a specified database table.
    *   Sends a formatted summary report to the configured Lark bot for each account.
*   **Configuration:**
    *   **`send_to_lark_settings.yaml`:** Define the accounts, strategies, and `msg_bot_settings` (webhook URL, secret).
    *   **`common/db.json`:** Ensure database credentials are correct.
*   **Usage:**
    ```bash
    python run_send_analysis_to_msg_bot.py
    ```

### `run_send_market_analysis_to_msg_bot.py`

This script fetches and reports the latest market statistics for specified trading pairs.

*   **Purpose:** To provide a snapshot of recent market conditions for relevant symbols.
*   **Functionality:**
    *   Loads market configurations (symbols, exchanges) from the `market_stats` section of `send_to_lark_settings.yaml`.
    *   Queries a database table (e.g., `mds_stat`) for the most recent statistics record within the last 24 hours for each symbol.
    *   Sends a formatted message with the latest market data to the configured Lark bot.
*   **Configuration:**
    *   **`send_to_lark_settings.yaml`:** Under the `market_stats` key, define the markets to monitor and the `msg_bot_settings`.
    *   **`common/db.json`:** Ensure database credentials are correct.
*   **Usage:**
    ```bash
    python run_send_market_analysis_to_msg_bot.py
    ```

## Future Implementations

*   **Market Statistics:**
    *   Integrate market data to provide broader context for trade analysis.
    *   Calculate and display key market statistics, such as:
        *   Market volatility
        *   Correlation with major indices
        *   Key support and resistance levels
    *   This will allow for a more comprehensive evaluation of trading strategy performance against market conditions.